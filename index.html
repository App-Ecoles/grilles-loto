<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Loto Scolaire Pro - Correctif Final</title>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; padding: 20px; color: #333; }
        .controls { background: white; padding: 25px; border-radius: 12px; max-width: 800px; margin: 0 auto 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border-top: 5px solid #e67e22; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 15px; }
        .full-width { grid-column: span 4; }
        label { display: block; font-weight: bold; margin-bottom: 5px; font-size: 0.85em; color: #555; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
        
        .library-zone { background: #fff9f0; padding: 15px; border-radius: 8px; border: 1px dashed #e67e22; margin-top: 15px; }
        .library-actions { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
        
        .actions { margin-top: 20px; display: flex; gap: 10px; }
        button { padding: 10px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.2s; color: white; }
        .btn-gen { background: #3498db; flex: 1; font-size: 1.1em; }
        .btn-print { background: #27ae60; flex: 1; font-size: 1.1em; }
        .btn-save { background: #e67e22; }
        .btn-del { background: #e74c3c; }
        .btn-tool { background: #95a5a6; font-size: 0.8em; }
        button:hover { opacity: 0.9; }

        .grid-container { display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; }
        .bingo-card { border: 2px solid #000; background: white; padding: 15px; width: 280px; page-break-inside: avoid; margin-bottom: 20px; }
        .student-name { border-bottom: 1px solid #000; margin-bottom: 10px; padding-bottom: 5px; font-style: italic; font-size: 0.8em; }
        .grid { display: grid; border: 2px solid #000; }
        .cell { border: 1px solid #000; min-height: 80px; display: flex; align-items: center; justify-content: center; text-align: center; padding: 5px; font-weight: bold; overflow: hidden; background: #fff; }
        .cell img { max-width: 95%; max-height: 75px; object-fit: contain; }

        #status-msg { text-align: center; font-weight: bold; color: #e67e22; margin-bottom: 10px; display: none; padding: 10px; background: #fff; border-radius: 8px; }

        @media print {
            .controls { display: none; }
            body { background: white; padding: 0; }
            .grid-container { display: block; }
            .bingo-card { margin-bottom: 40px; width: 45%; float: left; margin-right: 2%; }
        }
    </style>
</head>
<body onload="refreshLibraryList()">

<div class="controls">
    <h2>üìö Loto Scolaire (V3 - Stable)</h2>
    
    <div class="library-zone">
        <label>Charger une liste enregistr√©e :</label>
        <div style="display: flex; gap: 10px;">
            <select id="librarySelect" onchange="loadFromLibrary()" style="flex: 2;">
                <option value="">-- Mes Listes --</option>
            </select>
            <button class="btn-del" onclick="deleteFromLibrary()">Supprimer</button>
        </div>
        <div class="library-actions">
            <button class="btn-tool" onclick="exportLibrary()">üì§ Exporter</button>
            <button class="btn-tool" onclick="document.getElementById('importFile').click()">üì• Importer</button>
            <input type="file" id="importFile" style="display:none" onchange="importLibrary(event)">
        </div>
    </div>

    <hr style="margin: 20px 0; border: 0; border-top: 1px solid #eee;">

    <div class="form-grid">
        <div class="form-group"><label>Colonnes</label><input type="number" id="cols" value="3"></div>
        <div class="form-group"><label>Lignes</label><input type="number" id="rows" value="3"></div>
        <div class="form-group"><label>Taille Texte</label><input type="number" id="fontSize" value="20"></div>
        <div class="form-group">
            <label>Police</label>
            <select id="fontFamily">
                <option value="'Segoe UI', sans-serif">B√¢ton</option>
                <option value="'Dancing Script', cursive">Cursive</option>
                <option value="monospace">Machine</option>
            </select>
        </div>

        <div class="form-group full-width">
            <label>√âl√©ments (Mots simples ou <strong>img:mot</strong> pour une image)</label>
            <textarea id="customList" rows="3" placeholder="chat, chien, img:pomme, img:poire..."></textarea>
        </div>

        <div class="form-group full-width">
            <label>Nom de la liste :</label>
            <div style="display:flex; gap: 10px;">
                <input type="text" id="listName" placeholder="Ma nouvelle liste">
                <button class="btn-save" style="flex: 0.5;" onclick="saveToLibrary()">üíæ Enregistrer</button>
            </div>
        </div>
        <div class="form-group full-width">
            <label>Nombre de fiches</label>
            <input type="number" id="qty" value="12">
        </div>
    </div>

    <div class="actions">
        <button class="btn-gen" onclick="generate()">‚ú® G√©n√©rer les grilles</button>
        <button class="btn-print" onclick="window.print()">üñ®Ô∏è Imprimer en PDF</button>
    </div>
</div>

<div id="status-msg">Chargement des images... Merci de patienter. ‚è≥</div>
<div id="print-area" class="grid-container"></div>

<script>
    var PIXABAY_KEY = '54483777-8e2234ae5d4995afcccfc80ac';
    var library = JSON.parse(localStorage.getItem('lotoLibrary')) || {};

    function saveToLibrary() {
        var name = document.getElementById('listName').value.trim();
        var content = document.getElementById('customList').value.trim();
        if (!name || !content) return alert("Nom et contenu requis !");
        library[name] = content;
        localStorage.setItem('lotoLibrary', JSON.stringify(library));
        refreshLibraryList();
    }

    function refreshLibraryList() {
        var select = document.getElementById('librarySelect');
        select.innerHTML = '<option value="">-- Mes Listes --</option>';
        Object.keys(library).sort().forEach(function(name) {
            var opt = document.createElement('option');
            opt.value = name; opt.innerText = name;
            select.appendChild(opt);
        });
    }

    function loadFromLibrary() {
        var name = document.getElementById('librarySelect').value;
        if (name) {
            document.getElementById('customList').value = library[name];
            document.getElementById('listName').value = name;
        }
    }

    function deleteFromLibrary() {
        var name = document.getElementById('librarySelect').value;
        if (name && confirm("Supprimer " + name + " ?")) {
            delete library[name];
            localStorage.setItem('lotoLibrary', JSON.stringify(library));
            refreshLibraryList();
        }
    }

    function exportLibrary() {
        var dataStr = JSON.stringify(library);
        var dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
        var link = document.createElement('a');
        link.setAttribute('href', dataUri);
        link.setAttribute('download', 'ma-bibliotheque-loto.json');
        link.click();
    }

    function importLibrary(event) {
        var reader = new FileReader();
        reader.onload = function(e) {
            try {
                var importedData = JSON.parse(e.target.result);
                library = Object.assign({}, library, importedData);
                localStorage.setItem('lotoLibrary', JSON.stringify(library));
                refreshLibraryList();
                alert("Importation r√©ussie !");
            } catch (err) { alert("Erreur de lecture."); }
        };
        reader.readAsText(event.target.files[0]);
    }

    // Version simplifi√©e de la recherche d'image
    async function getImg(keyword) {
        try {
            var url = "https://pixabay.com/api/?key=" + PIXABAY_KEY + "&q=" + encodeURIComponent(keyword) + "&image_type=vector&lang=fr&per_page=3";
            var resp = await fetch(url);
            var data = await resp.json();
            return (data.hits && data.hits.length > 0) ? data.hits[0].webformatURL : null;
        } catch (e) { return null; }
    }

    async function generate() {
        var cols = parseInt(document.getElementById('cols').value) || 3;
        var rows = parseInt(document.getElementById('rows').value) || 3;
        var qty = parseInt(document.getElementById('qty').value) || 1;
        var fSize = document.getElementById('fontSize').value;
        var font = document.getElementById('fontFamily').value;
        var totalCells = cols * rows;
        var sourceArray = document.getElementById('customList').value.split(',').map(function(s){ return s.trim(); }).filter(function(s){ return s !== ""; });

        if (sourceArray.length < totalCells) {
            alert("Il faut au moins " + totalCells + " √©l√©ments.");
            return;
        }

        document.getElementById('status-msg').style.display = 'block';
        var container = document.getElementById('print-area');
        container.innerHTML = '';

        // Cache des images
        var cache = {};
        for (var i = 0; i < sourceArray.length; i++) {
            var item = sourceArray[i];
            if (item.indexOf('img:') === 0 && !cache[item]) {
                var query = item.replace('img:', '');
                cache[item] = await getImg(query);
            }
        }

        for (var g = 0; g < qty; g++) {
            var shuffled = sourceArray.slice().sort(function(){ return 0.5 - Math.random(); });
            var selection = shuffled.slice(0, totalCells);
            
            var card = document.createElement('div');
            card.className = 'bingo-card';
            card.innerHTML = '<div class="student-name">Nom : ...........................</div>';
            
            var grid = document.createElement('div');
            grid.className = 'grid';
            grid.style.gridTemplateColumns = "repeat(" + cols + ", 1fr)";

            selection.forEach(function(item) {
                var cell = document.createElement('div');
                cell.className = 'cell';
                
                if (item.indexOf('img:') === 0) {
                    var imgUrl = cache[item];
                    if (imgUrl) {
                        cell.innerHTML = '<img src="' + imgUrl + '">';
                    } else {
                        cell.innerText = item.replace('img:', '');
                    }
                } else {
                    cell.innerText = item;
                    cell.style.fontFamily = font;
                    cell.style.fontSize = (font.indexOf('Dancing Script') !== -1) ? (parseInt(fSize) + 8) + 'px' : fSize + 'px';
                }
                grid.appendChild(cell);
            });
            
            card.appendChild(grid);
            container.appendChild(card);
        }
        document.getElementById('status-msg').style.display = 'none';
    }
</script>
</body>
</html>


